name: Dev CI/CD with Auto-merge

on:
  push:
    branches:
      - dev

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  quality-checks:
    name: Code Quality & Tests
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:8.0.17
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
          MONGO_INITDB_DATABASE: tech_challenge
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run all quality checks
        id: quality
        run: |
          set +e
          set -o pipefail

          LINT_FAILED=0
          TEST_FAILED=0
          E2E_FAILED=0

          echo "Running linter..."
          pnpm run lint 2>&1 | tee lint-output.txt
          LINT_FAILED=$?

          echo "Running unit tests..."
          pnpm run test 2>&1 | tee test-output.txt
          TEST_FAILED=$?

          echo "Running E2E tests..."
          pnpm run test:e2e 2>&1 | tee e2e-output.txt
          E2E_FAILED=$?

          if [ $LINT_FAILED -ne 0 ] || [ $TEST_FAILED -ne 0 ] || [ $E2E_FAILED -ne 0 ]; then
            echo "::error::Quality checks failed"
            echo "has-errors=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "has-errors=false" >> $GITHUB_OUTPUT
          echo "All quality checks passed"
        env:
          MONGODB_URI: mongodb://test:test@localhost:27017/tech_challenge?authSource=admin

      - name: Upload test outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-outputs
          path: |
            lint-output.txt
            test-output.txt
            e2e-output.txt
          retention-days: 7

    outputs:
      has-errors: ${{ steps.quality.outputs.has-errors }}

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: quality-checks
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/image.tar
          retention-days: 1

  security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: build-image
    permissions:
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/image.tar

      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Run Trivy scan
        id: trivy
        run: |
          set +e
          trivy image --exit-code 1 --severity HIGH,CRITICAL \
            --format sarif --output trivy-results.sarif \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ github.sha }}
          TRIVY_EXIT=$?

          trivy image --severity HIGH,CRITICAL \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ github.sha }} | tee trivy-output.txt

          if [ $TRIVY_EXIT -ne 0 ]; then
            echo "has-vulnerabilities=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "has-vulnerabilities=false" >> $GITHUB_OUTPUT

      - name: Upload Trivy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

      - name: Upload Trivy output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-output
          path: trivy-output.txt
          retention-days: 7

    outputs:
      has-vulnerabilities: ${{ steps.trivy.outputs.has-vulnerabilities }}

  report-failures:
    name: Report Failures
    runs-on: ubuntu-latest
    needs: [quality-checks, build-image, security-scan]
    if: always()
    permissions:
      issues: write

    steps:
      - name: Download all artifacts
        if: needs.quality-checks.outputs.has-errors == 'true' || needs.security-scan.outputs.has-vulnerabilities == 'true'
        uses: actions/download-artifact@v4

      - name: Analyze failures and create issue
        if: needs.quality-checks.outputs.has-errors == 'true' || needs.security-scan.outputs.has-vulnerabilities == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let issueBody = '## CI/CD Failure Report\n\n';
            issueBody += `**Branch:** dev\n`;
            issueBody += `**Commit:** ${{ github.sha }}\n`;
            issueBody += `**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n`;

            if ('${{ needs.quality-checks.outputs.has-errors }}' === 'true') {
              issueBody += '### Quality Check Failures\n\n';

              try {
                const lintOutput = fs.readFileSync('test-outputs/lint-output.txt', 'utf8');
                if (lintOutput.includes('ELIFECYCLE') || lintOutput.includes('error')) {
                  issueBody += '#### Linting Errors\n```\n' + lintOutput + '\n```\n\n';
                }
              } catch (e) {}

              try {
                const testOutput = fs.readFileSync('test-outputs/test-output.txt', 'utf8');
                if (testOutput.includes('FAIL') || testOutput.includes('ELIFECYCLE')) {
                  issueBody += '#### Unit Test Failures\n```\n' + testOutput + '\n```\n\n';
                }
              } catch (e) {}

              try {
                const e2eOutput = fs.readFileSync('test-outputs/e2e-output.txt', 'utf8');
                if (e2eOutput.includes('FAIL') || e2eOutput.includes('ELIFECYCLE')) {
                  issueBody += '#### E2E Test Failures\n```\n' + e2eOutput + '\n```\n\n';
                }
              } catch (e) {}
            }

            if ('${{ needs.security-scan.outputs.has-vulnerabilities }}' === 'true') {
              issueBody += '### Security Vulnerabilities\n\n';
              try {
                const trivyOutput = fs.readFileSync('trivy-output/trivy-output.txt', 'utf8');
                issueBody += '```\n' + trivyOutput + '\n```\n\n';
              } catch (e) {}
            }

            issueBody += '---\n';
            issueBody += '*This issue was automatically created by the CI/CD pipeline.*';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[DEV] CI/CD Failure - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['ci-failure', 'automated', 'dev']
            });

  auto-merge-to-main:
    name: Auto-merge to Main
    runs-on: ubuntu-latest
    needs: [quality-checks, build-image, security-scan]
    if: |
      needs.quality-checks.outputs.has-errors == 'false' &&
      needs.security-scan.outputs.has-vulnerabilities == 'false'
    permissions:
      contents: write

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge dev to main
        run: |
          git fetch origin main:main
          git checkout main
          git merge dev --no-ff -m "Auto-merge dev to main - All quality checks passed

          This automated merge was triggered after successful:
          - Code quality checks (lint, tests, e2e)
          - Docker image build
          - Security scan (Trivy)

          Commit: ${{ github.sha }}
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Push to main
        run: git push origin main

  push-image:
    name: Push to Registry
    runs-on: ubuntu-latest
    needs: auto-merge-to-main
    permissions:
      packages: write

    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/image.tar

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push image
        run: |
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ github.sha }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ github.sha }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}

          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}
